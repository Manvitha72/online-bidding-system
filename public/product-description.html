<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Description</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="src/css/home.css"/>
    <style>
        .card.disabled {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            opacity: 0.6;
            pointer-events: none;
        }
        .auction-ended-banner {
            display: none;
            padding: 10px;
            color: #dc1d30;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="custom-navbar container-fluid">
            <div class="left">
                <img src="images/logo.png" style="width: 80px;">
                <a class="custom-brand navbar-brand" href="#">Manvi72 Auctions</a>
            </div>
            <div class="right">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="custom-ul navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link active" href="place-auction.html">Auction</a>
                    </li>
                    <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        About Us
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Our Mission</a></li>
                        <li><a class="dropdown-item" href="#">Testimonials</a></li>
                        <li><a class="dropdown-item" href="#">FAQ</a></li>
                    </ul>
                    </li>
                    <li><i class="bi bi-person-fill" style="color:black;"></i></li>
                    <li><button class="logout-btn" onclick="location.href='home.html'">Logout</button></li>
                </ul>
                </div>
            </div>
        </div>
    </nav>
    <div class="prod-des-container container mt-4">
        <div id="auction-ended-banner" class="auction-ended-banner">
            <strong>Auction ended!</strong> No further bids can be placed
        </div>
        <div class="row gx-4">
            <div class="col-md-4">
                <div class="card" id="product-card">
                    <img src="" id="product-image" class="card-img-top" alt="Product Image">
                    <div class="card-body">
                        <h5 class="card-title" id="product-name"></h5>
                        <p class="card-text" id="product-description"></p>
                        <p class="card-text"><strong>Current Bid:</strong> $<span id="current-bid"></span></p>
                        <button class="btn btn-primary" id="bid-now-btn">Bid Now</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5>Bid History</h5>
                        <ul id="bid-list" class="list-group"></ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5>User Reviews</h5>
                        <ul id="review-list" class="list-group"></ul>
                        <form id="review-form" class="mt-3">
                            <div class="mb-3">
                                <label for="review-text" class="form-label">Your Review</label>
                                <textarea class="form-control" id="review-text" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer bg-dark text-white py-4 mt-auto">
        <div class="footer-container text-center">
            <div class="row">
                <div class="d-flex align-items-center mb-3">
                    <img src="images/logo.png" style="width: 40px;" class="me-2">
                    <h5 class="mb-0">Manvi72 Auctions</h5>
                </div>
                <div class="col-lg-4 mb-3 mb-lg-0">
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white text-decoration-none">Products</a></li>
                        <li><a href="#" class="text-white text-decoration-none">About us</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 mb-3 mb-lg-0">
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white text-decoration-none">Auctions</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Bidding</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h5 class="mb-3">Follow Us</h5>
                    <a href="#" class="text-white me-3"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="text-white me-3"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="text-white me-3"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="text-white"><i class="bi bi-github"></i></a>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p class="mb-0">&copy; 2024, All Rights Reserved by Genix</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bid Now Modal -->
    <div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bidModalLabel">Place Your Bid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bid-form">
                        <div class="mb-3">
                            <label for="bid-amount" class="form-label">Bid Amount ($)</label>
                            <input type="number" class="form-control" id="bid-amount" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Bid</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const productId = new URLSearchParams(window.location.search).get('id');
        const bidModal = new bootstrap.Modal(document.getElementById('bidModal'));

        document.getElementById('bid-now-btn').addEventListener('click', () => {
            bidModal.show();
        });

        document.getElementById('bid-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bidAmount = document.getElementById('bid-amount').value;
            const response = await fetch('/api/place-bid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, bidAmount })
            });

            if (response.ok) {
                bidModal.hide();
                loadProductDetails();  // Refresh details to include the new bid
            } else {
                const errorData = await response.json();
                console.error('Failed to place bid:', errorData);
                alert('Failed to place bid: ' + errorData.error);
            }
        });

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reviewText = document.getElementById('review-text').value;

            try {
                const response = await fetch('/api/submit-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, review: reviewText })
                });

                if (response.ok) {
                    loadProductReviews();
                    document.getElementById('review-text').value = '';
                } else {
                    const errorData = await response.json();
                    console.error('Failed to submit review:', errorData);
                    alert('Failed to submit review: ' + errorData.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Network error: ' + error.message);
            }
        });

        async function loadProductDetails() {
            const response = await fetch(`/api/product-details?id=${productId}`);
            const product = await response.json();
            
            // Display product details
            document.getElementById('product-image').src = product.image;
            document.getElementById('product-name').innerText = product.productName;
            document.getElementById('product-description').innerText = product.productDescription;
            document.getElementById('current-bid').innerText = product.currentBid;

            // Display bids
            const bidList = document.getElementById('bid-list');
            bidList.innerHTML = '';
            product.bids.forEach(bid => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item');
                // Adjust according to the schema fields
                listItem.innerText = `${bid.username} bids $${bid.amount} on ${new Date(bid.timestamp).toLocaleString()}`;
                bidList.appendChild(listItem);
            });

            // Handle auction end
            const now = new Date();
            const endTime = new Date(product.endTime);
            if (now > endTime) {
                document.getElementById('auction-ended-banner').style.display = 'block';
                document.getElementById('product-card').classList.add('disabled');
                document.getElementById('bid-now-btn').style.display = 'none';
            }
        }


        async function loadProductReviews() {
            try {
                const response = await fetch(`/api/product-reviews?productId=${productId}`);
                const reviews = await response.json();
                const reviewList = document.getElementById('review-list');
                reviewList.innerHTML = '';
                reviews.forEach(review => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('list-group-item');
                    listItem.innerText = `${review.username}: ${review.review}`;
                    reviewList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Failed to load reviews:', error);
                alert('Failed to load reviews: ' + error.message);
            }
        }

        loadProductDetails();
        loadProductReviews();
    </script>
</body>
</html>
